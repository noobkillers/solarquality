<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPQMS - Solar Quality Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwTKNRCR51Nb9FXsN61EZYfZgXjt9f1UQ",
            authDomain: "quality-management-7cdaf.firebaseapp.com",
            projectId: "quality-management-7cdaf",
            storageBucket: "quality-management-7cdaf.firebasestorage.app",
            messagingSenderId: "593793850642",
            appId: "1:593793850642:web:c61abe29de4e7fd01a27cb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firebase = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy };
    </script>

    <style>
        .hidden { display: none !important; }
        .modal { transition: all 0.3s; }
        .nav-link.active { background: #dbeafe; color: #1d4ed8; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100">

<div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-xl">
        <div class="p-6 text-center border-b">
            <h1 class="text-2xl font-bold text-blue-700">SPQMS</h1>
        </div>
        <nav class="mt-6">
            <a onclick="navigate('dashboard')" class="nav-link block px-6 py-4 hover:bg-gray-50 cursor-pointer">Dashboard</a>
            <a onclick="navigate('sites')" class="nav-link block px-6 py-4 hover:bg-gray-50 cursor-pointer">Site Management</a>
            <a onclick="navigate('observations')" class="nav-link block px-6 py-4 hover:bg-gray-50 cursor-pointer">Observations</a>
            <a onclick="navigate('ncrs')" class="nav-link block px-6 py-4 hover:bg-gray-50 cursor-pointer">NCR & RCA</a>

            <!-- AI Assistant -->
            <div class="p-6 mt-10 bg-gradient-to-br from-indigo-600 to-purple-700 text-white">
                <h3 class="font-bold text-lg">AI Assistant (Gemini)</h3>
                <p class="text-sm opacity-90 mt-1">Get instant RCA & CAPA suggestions</p>
                <textarea id="ai-prompt" class="w-full mt-3 p-3 rounded-lg text-gray-900 text-sm" rows="3" placeholder="e.g. Micro-cracks on modules at Site-05"></textarea>
                <button id="ai-btn" class="w-full mt-3 bg-white text-indigo-700 font-bold py-3 rounded-lg hover:bg-gray-100">Get AI Suggestion</button>
                <div id="ai-loading" class="hidden mt-3 text-center">Thinking...</div>
                <pre id="ai-response" class="hidden mt-4 p-4 bg-white/20 rounded-lg text-sm whitespace-pre-wrap"></pre>
            </div>
        </nav>
    </aside>

    <!-- Main -->
    <div class="flex-1 overflow-y-auto">
        <header class="bg-white shadow p-6 flex justify-between items-center">
            <h1 id="page-title" class="text-3xl font-bold text-gray-800">Dashboard</h1>
            <div class="flex items-center gap-4">
                <select id="site-filter" class="px-4 py-2 border rounded-lg">
                    <option value="all">All Sites</option>
                </select>
                <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">QE</div>
            </div>
        </header>

        <div class="p-8">
            <!-- Dashboard -->
            <div id="page-dashboard" class="page-content">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <p class="text-gray-500 text-sm">Total Observations</p>
                        <p id="total-obs" class="text-4xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <p class="text-gray-500 text-sm">Open NCRs</p>
                        <p id="open-ncrs" class="text-4xl font-bold text-red-600">0</p>
                    </div>
                </div>
            </div>

            <!-- Sites Page -->
            <div id="page-sites" class="hidden page-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Site Management</h2>
                    <button onclick="openModal('site-modal')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">+ Add Site</button>
                </div>
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">Site Name</th>
                                <th class="px-6 py-4 text-left">Location</th>
                                <th class="px-6 py-4 text-left">Capacity</th>
                                <th class="px-6 py-4 text-left">Status</th>
                                <th class="px-6 py-4 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sites-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Observations Page -->
            <div id="page-observations" class="hidden page-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Quality Observations</h2>
                    <button onclick="openModal('obs-modal')" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">+ Log Observation</button>
                </div>
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left">Site</th>
                                <th class="px-6 py-4 text-left">Title</th>
                                <th class="px-6 py-4 text-left">Severity</th>
                                <th class="px-6 py-4 text-left">Date</th>
                                <th class="px-6 py-4 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="obs-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="site-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6">Add New Site</h2>
        <form id="site-form">
            <input type="text" id="site-name" placeholder="Site Name" class="w-full p-3 border rounded mb-4" required>
            <input type="text" id="site-location" placeholder="Location" class="w-full p-3 border rounded mb-4" required>
            <input type="number" id="site-capacity" placeholder="Capacity (MW)" class="w-full p-3 border rounded mb-4" required>
            <select id="site-status" class="w-full p-3 border rounded mb-6">
                <option>Active</option>
                <option>Under Construction</option>
            </select>
            <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded">Save Site</button>
                <button type="button" onclick="closeModal('site-modal')" class="flex-1 bg-gray-300 py-3 rounded">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="obs-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl w-full max-w-lg">
        <h2 class="text-2xl font-bold mb-6">Log New Observation</h2>
        <form id="obs-form">
            <select id="obs-site" class="w-full p-3 border rounded mb-4" required>
                <option value="">Select Site</option>
            </select>
            <input type="text" id="obs-title" placeholder="Observation Title" class="w-full p-3 border rounded mb-4" required>
            <textarea id="obs-desc" placeholder="Description" class="w-full p-3 border rounded mb-4" rows="4"></textarea>
            <select id="obs-severity" class="w-full p-3 border rounded mb-6">
                <option>Minor</option>
                <option>Major</option>
                <option>Critical</option>
            </select>
            <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded">Save Observation</button>
                <button type="button" onclick="closeModal('obs-modal')" class="flex-1 bg-gray-300 py-3 rounded">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- FINAL WORKING SCRIPT -->
<script type="module">
    import { collection, addDoc, deleteDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    const db = window.db;

    let sites = [];
    let observations = [];

    // Navigation
    window.navigate = (page) => {
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        const pageEl = document.getElementById('page-' + page);
        if (pageEl) pageEl.classList.remove('hidden');
        document.getElementById('page-title').textContent = page.charAt(0).toUpperCase() + page.slice(1);
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.querySelector(`a[onclick="navigate('${page}')"]`)?.classList.add('active');
    };

    // Modal Functions
    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => {
        document.getElementById(id).classList.add('hidden');
        document.getElementById(id).querySelector('form')?.reset();
    };

    // Save Site
    document.getElementById('site-form').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('site-name').value,
            location: document.getElementById('site-location').value,
            capacity: parseFloat(document.getElementById('site-capacity').value),
            status: document.getElementById('site-status').value,
            createdAt: serverTimestamp()
        };
        await addDoc(collection(db, 'sites'), data);
        closeModal('site-modal');
    };

    // Save Observation
    document.getElementById('obs-form').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            site: document.getElementById('obs-site').value,
            title: document.getElementById('obs-title').value,
            desc: document.getElementById('obs-desc').value,
            severity: document.getElementById('obs-severity').value,
            createdAt: serverTimestamp()
        };
        await addDoc(collection(db, 'observations'), data);
        closeModal('obs-modal');
    };

    // Render Sites
    const renderSites = () => {
        const tbody = document.getElementById('sites-tbody');
        tbody.innerHTML = sites.map(s => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-6 py-4 font-medium">${s.name}</td>
                <td class="px-6 py-4">${s.location}</td>
                <td class="px-6 py-4">${s.capacity} MW</td>
                <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs bg-green-100 text-green-800">${s.status}</span></td>
                <td class="="px-6 py-4"><button onclick="deleteSite('${s.id}')" class="text-red-600 hover:underline">Delete</button></td>
            </tr>
        `).join('');

        // Update dropdowns
        const select = document.getElementById('obs-site');
        select.innerHTML = '<option value="">Select Site</option>' + sites.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        document.getElementById('site-filter').innerHTML = '<option value="all">All Sites</option>' + sites.map(s => `<option>${s.name}</option>`).join('');
    };

    // Render Observations
    const renderObservations = () => {
        const tbody = document.getElementById('obs-tbody');
        tbody.innerHTML = observations.map(o => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-6 py-4">${o.site}</td>
                <td class="px-6 py-4 font-medium">${o.title}</td>
                <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs ${o.severity === 'Critical' ? 'bg-red-100 text-red-800' : o.severity === 'Major' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100'}">${o.severity}</span></td>
                <td class="px-6 py-4">${new Date(o.createdAt?.toDate()).toLocaleDateString()}</td>
                <td class="px-6 py-4"><button onclick="deleteObs('${o.id}')" class="text-red-600 hover:underline">Delete</button></td>
            </tr>
        `).join('');
        document.getElementById('total-obs').textContent = observations.length;
    };

    window.deleteSite = async (id) => { if (confirm('Delete site?')) await deleteDoc(doc(db, 'sites', id)); };
    window.deleteObs = async (id) => { if (confirm('Delete observation?')) await deleteDoc(doc(db, 'observations', id)); };

    // Real-time Listeners (FIXED!)
    onSnapshot(collection(db, 'sites'), (snap) => {
        sites = [];
        snap.forEach(doc => sites.push({ id: doc.id, ...doc.data() }));
        renderSites();
    });

    onSnapshot(collection(db, 'observations'), (snap) => {
        observations = [];
        snap.forEach(doc => observations.push({ id: doc.id, ...doc.data() }));
        renderObservations();
    });

    // AI Assistant (Gemini)
    document.getElementById('ai-btn').onclick = async () => {
        const prompt = document.getElementById('ai-prompt').value.trim();
        if (!prompt) return;
        document.getElementById('ai-loading').classList.remove('hidden');
        document.getElementById('ai-response').classList.add('hidden');

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyBFQHzmHAA6fXHbi_9_Z0xpniMnoeeGz4s`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: `You are a solar quality expert. Analyze: "${prompt}"\n\nSuggest:\n1. Possible Root Causes\n2. Corrective Actions\n3. Preventive Actions` }] }]
                })
            });
            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text;
            document.getElementById('ai-response').textContent = text;
            document.getElementById('ai-response').classList.remove('hidden');
        } catch (e) {
            document.getElementById('ai-response').textContent = "AI temporarily unavailable";
            document.getElementById('ai-response').classList.remove('hidden');
        }
        document.getElementById('ai-loading').classList.add('hidden');
    };

    // Start
    navigate('dashboard');
</script>
</body>
</html>
