<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPQMS - Firebase Import Demo</title>

  <!-- Tailwind (for quick layout) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body { background:#f1f5f9; color:#0f172a }
    .container { max-width:1100px; margin:28px auto; padding:16px; }
    table { width:100%; border-collapse:collapse }
    table th, table td { padding:8px 10px; border:1px solid #e6eef8; text-align:left; font-size:14px }
    @media (max-width:640px){
      .grid-cols-3 { grid-template-columns: repeat(1, minmax(0,1fr)); }
      table th { display:none }
      table td { display:block; width:100% }
      table tr { margin-bottom:12px; display:block; border-bottom:1px solid #e6eef8; padding-bottom:8px }
    }
  </style>
</head>
<body>
  <div class="container bg-white rounded-md p-6 shadow">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">SPQMS — Firestore Import</h1>
      <div class="flex items-center gap-3">
        <div id="user-info" class="text-sm text-slate-600"></div>
        <button id="signin-btn" class="px-3 py-2 bg-blue-600 text-white rounded">Sign in with Google</button>
        <button id="signout-btn" class="px-3 py-2 bg-gray-200 text-black rounded hidden">Sign out</button>
      </div>
    </div>

    <div class="mb-6">
      <p class="text-sm text-slate-600">Import Excel files into Firestore collections. Excel file must have column headers matching your fields (e.g., id, name, site, date ...). Rows with <strong>id</strong> will be upserted; rows without id will be assigned an id.</p>
    </div>

    <div class="grid grid-cols-3 gap-4 mb-6">
      <!-- For each collection: Import button & input -->
      <div class="p-4 bg-slate-50 rounded">
        <h3 class="font-semibold mb-2">Sites</h3>
        <input id="import-sites-file" type="file" accept=".xlsx,.xls,.csv" />
        <div class="mt-3">
          <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="refreshCollection('sites')">Refresh sites</button>
        </div>
      </div>

      <div class="p-4 bg-slate-50 rounded">
        <h3 class="font-semibold mb-2">Observations</h3>
        <input id="import-observations-file" type="file" accept=".xlsx,.xls,.csv" />
        <div class="mt-3">
          <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="refreshCollection('observations')">Refresh obs</button>
        </div>
      </div>

      <div class="p-4 bg-slate-50 rounded">
        <h3 class="font-semibold mb-2">NCRs</h3>
        <input id="import-ncrs-file" type="file" accept=".xlsx,.xls,.csv" />
        <div class="mt-3">
          <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="refreshCollection('ncrs')">Refresh ncrs</button>
        </div>
      </div>

      <div class="p-4 bg-slate-50 rounded">
        <h3 class="font-semibold mb-2">CAPA</h3>
        <input id="import-capa-file" type="file" accept=".xlsx,.xls,.csv" />
        <div class="mt-3">
          <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="refreshCollection('capa')">Refresh capa</button>
        </div>
      </div>

      <div class="p-4 bg-slate-50 rounded">
        <h3 class="font-semibold mb-2">Incidents</h3>
        <input id="import-incidents-file" type="file" accept=".xlsx,.xls,.csv" />
        <div class="mt-3">
          <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="refreshCollection('incidents')">Refresh inc.</button>
        </div>
      </div>

      <div class="p-4 bg-yellow-50 rounded">
        <h3 class="font-semibold mb-2">Quick actions</h3>
        <div class="flex flex-col gap-2">
          <button id="refresh-all" class="px-3 py-2 bg-indigo-600 text-white rounded">Refresh All</button>
          <button id="export-sample" class="px-3 py-2 bg-gray-200 rounded">Download sample template</button>
        </div>
      </div>
    </div>

    <div id="collections-area" class="space-y-6">
      <!-- Tables (filled programmatically) -->
      <section id="table-sites" class="hidden">
        <h3 class="font-semibold mb-2">Sites</h3>
        <div class="overflow-auto"><table id="sites-table"><thead><tr><th>id</th><th>name</th><th>location</th><th>capacity</th><th>status</th><th>incharge</th></tr></thead><tbody></tbody></table></div>
      </section>

      <section id="table-observations" class="hidden">
        <h3 class="font-semibold mb-2">Observations</h3>
        <div class="overflow-auto"><table id="observations-table"><thead><tr><th>id</th><th>date</th><th>site</th><th>type</th><th>category</th><th>severity</th><th>owner</th></tr></thead><tbody></tbody></table></div>
      </section>

      <section id="table-ncrs" class="hidden">
        <h3 class="font-semibold mb-2">NCRs</h3>
        <div class="overflow-auto"><table id="ncrs-table"><thead><tr><th>id</th><th>date</th><th>site</th><th>title</th><th>status</th></tr></thead><tbody></tbody></table></div>
      </section>

      <section id="table-capa" class="hidden">
        <h3 class="font-semibold mb-2">CAPA</h3>
        <div class="overflow-auto"><table id="capa-table"><thead><tr><th>id</th><th>type</th><th>source</th><th>action</th><th>due</th><th>status</th></tr></thead><tbody></tbody></table></div>
      </section>

      <section id="table-incidents" class="hidden">
        <h3 class="font-semibold mb-2">Incidents</h3>
        <div class="overflow-auto"><table id="incidents-table"><thead><tr><th>id</th><th>date</th><th>site</th><th>type</th><th>severity</th><th>status</th></tr></thead><tbody></tbody></table></div>
      </section>
    </div>
  </div>

  <!-- Firebase + Firestore integration (module) -->
  <script type="module">
    // -----------------------------
    // Firebase config (you pasted)
    // -----------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAwTKNRCR51Nb9FXsN61EZYfZgXjt9f1UQ",
      authDomain: "quality-management-7cdaf.firebaseapp.com",
      projectId: "quality-management-7cdaf",
      storageBucket: "quality-management-7cdaf.firebasestorage.app",
      messagingSenderId: "593793850642",
      appId: "1:593793850642:web:c61abe29de4e7fd01a27cb",
      measurementId: "G-WFC7KR1X5V"
    };

    // Import firebase modular SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import {
      getFirestore, collection, doc, getDocs, getDoc, setDoc, writeBatch, query, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Initialize
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) { /* analytics optional */ }
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Utility: collection name map
    const collMap = {
      sites: 'sites',
      observations: 'observations',
      ncrs: 'ncrs',
      capa: 'capa',
      incidents: 'incidents'
    };

    // UI references
    const signinBtn = document.getElementById('signin-btn');
    const signoutBtn = document.getElementById('signout-btn');
    const userInfo = document.getElementById('user-info');
    const refreshAllBtn = document.getElementById('refresh-all');
    const exportSampleBtn = document.getElementById('export-sample');

    // Sign-in/out handlers
    signinBtn.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert('Sign-in failed: ' + err.message);
      }
    });
    signoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        userInfo.textContent = user.displayName || user.email;
        signinBtn.classList.add('hidden');
        signoutBtn.classList.remove('hidden');
        // Auto-refresh data after sign-in
        refreshAllCollections();
      } else {
        userInfo.textContent = '';
        signinBtn.classList.remove('hidden');
        signoutBtn.classList.add('hidden');
        // Clear tables
        hideAllTables();
      }
    });

    // -------------------------
    // Firestore helpers
    // -------------------------
    function createId(prefix='DOC'){
      return (prefix+'-'+Math.floor(100+Math.random()*900)+'-'+String(Date.now()).slice(-6)).toString();
    }

    async function getCollectionData(key, limitRows=500){
      const colName = collMap[key];
      if(!colName) throw new Error('Invalid collection key: ' + key);
      const q = query(collection(db, colName), orderBy('updatedAt', 'desc'), limit(limitRows));
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // Upsert rows array into Firestore using batched writes
    async function importDataFirestore(dataKey, rowsArray){
      if(!Array.isArray(rowsArray) || rowsArray.length === 0) throw new Error('No rows to import');
      const colName = collMap[dataKey];
      if(!colName) throw new Error('Invalid dataKey: ' + dataKey);

      // Firestore batch has limit; commit in chunks of 400
      const CHUNK = 400;
      let batch = writeBatch(db);
      let ops = 0;
      for(let i=0;i<rowsArray.length;i++){
        const row = rowsArray[i];
        // Convert Date-like values (SheetJS may give actual Date objects or strings)
        for(const k of Object.keys(row)){
          if(Object.prototype.toString.call(row[k]) === '[object Date]'){
            // convert to ISO date string (you may change format)
            row[k] = row[k].toISOString().split('T')[0];
          }
        }
        let id = row.id || row.ID || row.Id || null;
        if(!id){
          id = createId(colName);
          row.id = id;
        }
        const ref = doc(db, colName, String(id));
        // merge to avoid deleting other fields
        batch.set(ref, { ...row, updatedAt: serverTimestamp() }, { merge: true });
        ops++;
        if(ops >= CHUNK){
          await batch.commit();
          batch = writeBatch(db);
          ops = 0;
        }
      }
      if(ops > 0) await batch.commit();
      // return a small summary
      return { imported: rowsArray.length, collection: colName };
    }

    // -------------------------
    // Import file handler (SheetJS)
    // -------------------------
    function setupImportInput(inputId, dataKey, tableSectionId){
      const input = document.getElementById(inputId);
      if(!input) return;
      input.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        if(!auth.currentUser){
          alert('Please sign in before importing.');
          input.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = async (evt) => {
          try {
            const data = evt.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
            if(!json || json.length === 0){
              alert('No rows found in the Excel sheet.');
              input.value = '';
              return;
            }
            const proceed = confirm(`Import ${json.length} rows into "${dataKey}"? Rows with matching 'id' will be updated; others will be added. Continue?`);
            if(!proceed){ input.value = ''; return; }
            // call Firestore import
            const res = await importDataFirestore(dataKey, json);
            alert(`Import complete: ${res.imported} rows -> ${res.collection}`);
            // refresh table
            await refreshCollection(dataKey);
          } catch (err) {
            console.error(err);
            alert('Import failed: ' + (err.message || err));
          } finally {
            input.value = '';
          }
        };
        // read as binary for SheetJS
        reader.readAsBinaryString(file);
      });
    }

    // setup inputs for all five collections
    setupImportInput('import-sites-file', 'sites', 'table-sites');
    setupImportInput('import-observations-file', 'observations', 'table-observations');
    setupImportInput('import-ncrs-file', 'ncrs', 'table-ncrs');
    setupImportInput('import-capa-file', 'capa', 'table-capa');
    setupImportInput('import-incidents-file', 'incidents', 'table-incidents');

    // -------------------------
    // Rendering & refresh
    // -------------------------
    function hideAllTables(){
      ['table-sites','table-observations','table-ncrs','table-capa','table-incidents'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
      });
    }

    function renderTable(key, rows){
      const map = {
        sites: { el: 'table-sites', tableId: 'sites-table', cols: ['id','name','location','capacity','status','incharge'] },
        observations: { el: 'table-observations', tableId: 'observations-table', cols: ['id','date','site','type','category','severity','owner'] },
        ncrs: { el: 'table-ncrs', tableId: 'ncrs-table', cols: ['id','date','site','title','status'] },
        capa: { el: 'table-capa', tableId: 'capa-table', cols: ['id','type','source','action','due','status'] },
        incidents: { el: 'table-incidents', tableId: 'incidents-table', cols: ['id','date','site','type','severity','status'] }
      };
      const conf = map[key];
      if(!conf) return;
      const section = document.getElementById(conf.el);
      const tbody = document.querySelector(`#${conf.tableId} tbody`);
      if(!tbody) return;
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        conf.cols.forEach(c => {
          const td = document.createElement('td');
          td.textContent = r[c] !== undefined && r[c] !== null ? String(r[c]) : '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      section.classList.remove('hidden');
    }

    async function refreshCollection(key){
      try {
        const rows = await getCollectionData(key);
        renderTable(key, rows);
      } catch(err){
        console.error('Refresh failed', err);
        alert('Failed to refresh: ' + (err.message || err));
      }
    }

    async function refreshAllCollections(){
      const keys = ['sites','observations','ncrs','capa','incidents'];
      for(const k of keys){
        await refreshCollection(k);
      }
    }

    refreshAllBtn.addEventListener('click', refreshAllCollections);

    // quick sample CSV download (template)
    exportSampleBtn.addEventListener('click', () => {
      const sample = [
        { id: 'S-001', name: 'Site A', location: 'City, State', capacity: 50, status: 'Active', incharge: 'John' }
      ];
      const ws = XLSX.utils.json_to_sheet(sample);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'sites_sample');
      XLSX.writeFile(wb, 'sites_sample.xlsx');
    });

    // small helper: get data (limit 500)
    async function getCollectionData(key){
      return await getCollectionData_internal(key, 500);
    }
    async function getCollectionData_internal(key, limitRows=500){
      const collectionName = collMap[key];
      if(!collectionName) throw new Error('Invalid key: ' + key);
      // simple get all (no ordering) — for simplicity we fetch documents directly
      const snap = await getDocs(collection(db, collectionName));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // Make refreshCollection available on window for debugging
    window.refreshCollection = refreshCollection;
    window.refreshAllCollections = refreshAllCollections;

    // On load, only show sign-in UI; data fetched after sign-in
    hideAllTables();
  </script>
</body>
</html>
