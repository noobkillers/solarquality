<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPQMS Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (xlsx) CDN for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }

        /* Active Nav Link */
        .nav-link.active {
            background-color: #e0f2fe; /* light-blue-100 */
            color: #0284c7; /* light-blue-700 */
            font-weight: 600;
        }
        .nav-link.active .nav-icon {
            color: #0284c7;
        }

        /* Page transitions (simple fade) */
        .page-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Ensure charts don't overflow */
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar Navigation -->
        <aside class="flex-shrink-0 w-64 bg-white shadow-lg overflow-y-auto">
            <div class="flex items-center justify-center p-6 border-b">
                <svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <span class="ml-3 text-2xl font-bold text-slate-700">SPQMS</span>
            </div>
            <nav class="mt-6">
                <a href="#dashboard" class="flex items-center px-6 py-3 text-gray-600 nav-link hover:bg-slate-50" onclick="navigate('dashboard')">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1V10a1 1 0 00-1-1H7a1 1 0 00-1 1v10a1 1 0 001 1h2z"></path></svg>
                    <span class="ml-4">Dashboard</span>
                </a>
                <a href="#sites" class="flex items-center px-6 py-3 text-gray-600 nav-link hover:bg-slate-50" onclick="navigate('sites')">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="ml-4">Site Management</span>
                </a>
                <a href="#observations" class="flex items-center px-6 py-3 text-gray-600 nav-link hover:bg-slate-50" onclick="navigate('observations')">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <span class="ml-4">Observations</span>
                </a>
                <a href="#ncrs" class="flex items-center px-6 py-3 text-gray-600 nav-link hover:bg-slate-50" onclick="navigate('ncrs')">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <span class="ml-4">NCR & RCA</span>
                </a>
                <a href="#capa" class="flex items-center px-6 py-3 text-gray-600 nav-link hover:bg-slate-50" onclick="navigate('capa')">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="ml-4">CAPA</span>
                </a>
                <a href="#incidents" class="flex items-center px-6 py-3 text-gray-600 nav-link hover:bg-slate-50" onclick="navigate('incidents')">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="ml-4">Incidents</span>
                </a>
                
                <!-- AI Assistant Panel -->
                <div class="px-6 mt-10">
                    <div class="p-4 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg text-white">
                        <div class="flex items-center">
                            <svg class="w-8 h-8 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM5.5 8a.5.5 0 000 1h1.75c.166 0 .33.02.486.058a3.5 3.5 0 013.028 3.028A.5.5 0 0011 12.5v1.75a.5.5 0 001 0V12.5a3.5 3.5 0 01-3.028-3.028A.5.5 0 008.5 9H6.75a.5.5 0 00-1 0v1.75a.5.5 0 001 0V9.5h.75a2.5 2.5 0 110 5H5.5a.5.5 0 000 1h1.75a.5.5 0 000-1H6.5a2.5 2.5 0 110-5H8.5a.5.5 0 00.447-.276A3.5 3.5 0 0111 5.5v.75a.5.5 0 001 0V5.5a3.5 3.5 0 01-3.028 3.028.5.5 0 00-.472.472A3.5 3.5 0 015.5 11h-.75a.5.5 0 00-1 0v1.75a.5.5 0 001 0V11.5h.75a2.5 2.5 0 110-5H5.5z" clip-rule="evenodd"></path></svg>
                            <span class="ml-3 font-semibold">AI Assistant</span>
                        </div>
                        <p class="mt-3 text-sm text-blue-100">Get suggestions for RCAs and Preventive Actions.</p>
                        <textarea id="ai-prompt-input" rows="3" class="w-full p-2 mt-3 text-sm text-slate-900 rounded-md border border-blue-200 focus:outline-none focus:ring-2 focus:ring-white" placeholder="e.g., 'Recurring micro-cracks on Type-A modules'"></textarea>
                        <button id="ai-suggest-btn" class="w-full px-4 py-2 mt-3 font-semibold text-center text-blue-700 bg-white rounded-md shadow hover:bg-blue-50">
                            Get Suggestion
                        </button>
                        <div id="ai-loading" class="hidden mt-3 text-sm text-center text-blue-100">
                            Thinking...
                        </div>
                        <div id="ai-result" class="mt-4 p-3 text-sm bg-blue-800 rounded-md text-blue-100 border border-blue-600 hidden"></div>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 w-full h-screen overflow-y-auto">
            <!-- Header -->
            <header class="flex items-center justify-between p-6 bg-white border-b">
                <div class="flex items-center">
                    <h1 id="page-title" class="text-3xl font-bold text-slate-800">Dashboard</h1>
                    <div class="ml-6">
                        <label for="site-filter" class="text-sm font-medium text-gray-700">Filter by Site:</label>
                        <select id="site-filter" class="p-2 ml-2 text-sm bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Sites</option>
                            <!-- Site options will be populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="mr-4 text-gray-600">Welcome, Quality Engineer</span>
                    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">
                        QE
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="p-8">
                
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content">
                    <!-- KPI Stat Cards -->
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 mb-8">
                        <div class="p-5 bg-white rounded-lg shadow-lg">
                            <div class="text-sm font-medium text-gray-500 uppercase">Total Observations</div>
                            <div class="mt-1 text-3xl font-bold text-blue-600" id="kpi-total-obs">...</div>
                        </div>
                        <div class="p-5 bg-white rounded-lg shadow-lg">
                            <div class="text-sm font-medium text-gray-500 uppercase">Open NCRs</div>
                            <div class="mt-1 text-3xl font-bold text-red-600" id="kpi-open-ncrs">...</div>
                        </div>
                        <div class="p-5 bg-white rounded-lg shadow-lg">
                            <div class="text-sm font-medium text-gray-500 uppercase">Pending RCAs</div>
                            <div class="mt-1 text-3xl font-bold text-yellow-600" id="kpi-pending-rcas">...</div>
                        </div>
                        <div class="p-5 bg-white rounded-lg shadow-lg">
                            <div class="text-sm font-medium text-gray-500 uppercase">Incidents (L30D)</div>
                            <div class="mt-1 text-3xl font-bold text-red-700" id="kpi-incidents">...</div>
                        </div>
                        <div class="p-5 bg-white rounded-lg shadow-lg md:col-span-1 lg:col-span-1 xl:col-span-1">
                            <div class="text-sm font-medium text-gray-500 uppercase">Quality Index</div>
                            <div class="mt-1 text-3xl font-bold text-green-600" id="kpi-quality-index">...%</div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-8">
                        <div class="p-6 bg-white rounded-lg shadow-lg">
                            <h3 class="mb-4 text-xl font-semibold text-slate-700">NCR Frequency Over Time</h3>
                            <div class="chart-container">
                                <canvas id="ncrTrendChart"></canvas>
                            </div>
                        </div>
                        <div class="p-6 bg-white rounded-lg shadow-lg">
                            <h3 class="mb-4 text-xl font-semibold text-slate-700">Site Performance Comparison</h3>
                            <div class="chart-container">
                                <canvas id="sitePerformanceChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity Table -->
                    <div class="p-6 bg-white rounded-lg shadow-lg">
                        <h3 class="mb-4 text-xl font-semibold text-slate-700">Recent Activity (All Sites)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-activity-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Site Management Page -->
                <div id="page-sites" class="hidden page-content">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-3xl font-bold text-slate-800">Site Management</h1>
                        <button class="px-6 py-2 font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" onclick="showModal('site-modal', 'Add New Site')">
                            Add New Site
                        </button>
                    </div>
                    <p class="mb-6 text-lg text-slate-600">
                        Add, view, and edit details for all solar project sites.
                    </p>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capacity (MW)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site Incharge</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                    </tr>
                                </thead>
                                <tbody id="sites-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Observations Page -->
                <div id="page-observations" class="hidden page-content">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-3xl font-bold text-slate-800">Quality Observation Tracker</h1>
                        <div class="flex gap-4">
                            <button class="px-6 py-2 font-medium text-blue-600 bg-white border border-blue-600 rounded-lg shadow-sm hover:bg-blue-50" onclick="exportData('observations')">
                                Export to Excel
                            </button>
                            <button class="px-6 py-2 font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" onclick="showModal('observation-modal', 'Log New Observation')">
                                Log New Observation
                            </button>
                        </div>
                    </div>
                    <p class="mb-6 text-lg text-slate-600">
                        Track daily field, process, and material quality observations.
                    </p>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Obs. ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                    </tr>
                                </thead>
                                <tbody id="observations-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- NCRs Page -->
                <div id="page-ncrs" class="hidden page-content">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-3xl font-bold text-slate-800">NCR & RCA Tracker</h1>
                        <div class="flex gap-4">
                            <button class="px-6 py-2 font-medium text-blue-600 bg-white border border-blue-600 rounded-lg shadow-sm hover:bg-blue-50" onclick="exportData('ncrs')">
                                Export to Excel
                            </button>
                            <button class="px-6 py-2 font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" onclick="showModal('ncr-modal', 'Raise New NCR')">
                                Raise New NCR
                            </button>
                        </div>
                    </div>
                    <p class="mb-6 text-lg text-slate-600">
                        Manage Non-Conformance Reports (NCRs) and Root Cause Analyses (RCAs).
                    </p>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NCR ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RCA Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                    </tr>
                                </thead>
                                <tbody id="ncrs-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CAPA Page -->
                <div id="page-capa" class="hidden page-content">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-3xl font-bold text-slate-800">Corrective & Preventive Actions (CAPA)</h1>
                        <div class="flex gap-4">
                            <button class="px-6 py-2 font-medium text-blue-600 bg-white border border-blue-600 rounded-lg shadow-sm hover:bg-blue-50" onclick="exportData('capa')">
                                Export to Excel
                            </button>
                            <button class="px-6 py-2 font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" onclick="showModal('capa-modal', 'Add New Action')">
                                Add New Action
                            </button>
                        </div>
                    </div>
                    <p class="mb-6 text-lg text-slate-600">
                        Track all Corrective and Preventive Actions to ensure continuous improvement.
                    </p>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type (CA/PA)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source (NCR/Obs.)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                    </tr>
                                </thead>
                                <tbody id="capa-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Incidents Page -->
                <div id="page-incidents" class="hidden page-content">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-3xl font-bold text-slate-800">Incident Reporting</h1>
                        <div class="flex gap-4">
                            <button class="px-6 py-2 font-medium text-blue-600 bg-white border border-blue-600 rounded-lg shadow-sm hover:bg-blue-50" onclick="exportData('incidents')">
                                Export to Excel
                            </button>
                            <button class="px-6 py-2 font-medium text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" onclick="showModal('incident-modal', 'Report New Incident')">
                                Report New Incident
                            </button>
                        </div>
                    </div>
                    <p class="mb-6 text-lg text-slate-600">
                        Log all near-miss and major safety incidents.
                    </p>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Incident ID</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                    </tr>
                                </thead>
                                <tbody id="incidents-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- =================================================================== -->
    <!-- MODALS -->
    <!-- =================================================================== -->

    <!-- Site Modal (Add/Edit) -->
    <div id="site-modal" class="fixed inset-0 z-40 items-center justify-center hidden p-4 modal-backdrop" onclick="hideModal('site-modal')">
        <div class="w-full max-w-2xl bg-white rounded-lg shadow-2xl" onclick="event.stopPropagation()">
            <form id="site-form" class="flex flex-col">
                <div class="flex items-center justify-between p-6 border-b">
                    <h2 id="site-modal-title" class="text-2xl font-bold text-slate-800">Add New Site</h2>
                    <button type="button" class="text-gray-400 hover:text-gray-600" onclick="hideModal('site-modal')">&times;</button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Site Name</label>
                            <input type="text" id="site-name" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Location (e.g., City, State)</label>
                            <input type="text" id="site-location" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Capacity (MW)</label>
                            <input type="number" id="site-capacity" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Status</label>
                            <select id="site-status" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <option value="Active">Active</option>
                                <option value="Planning">Planning</option>
                                <option value="Completed">Completed</option>
                                <option value="On Hold">On Hold</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Contractor</label>
                            <input type="text" id="site-contractor" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Site Incharge (Name)</label>
                            <input type="text" id="site-incharge" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-6 bg-gray-50 border-t">
                    <button type="button" class="px-6 py-2 mr-4 font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100" onclick="hideModal('site-modal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Observation Modal (Add/Edit) -->
    <div id="observation-modal" class="fixed inset-0 z-40 items-center justify-center hidden p-4 modal-backdrop" onclick="hideModal('observation-modal')">
        <div class="w-full max-w-2xl bg-white rounded-lg shadow-2xl" onclick="event.stopPropagation()">
            <form id="observation-form" class="flex flex-col">
                <div class="flex items-center justify-between p-6 border-b">
                    <h2 id="observation-modal-title" class="text-2xl font-bold text-slate-800">Log New Observation</h2>
                    <button type="button" class="text-gray-400 hover:text-gray-600" onclick="hideModal('observation-modal')">&times;</button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Site</label>
                            <select id="obs-site" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <!-- Site options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Observation Type</label>
                            <select id="obs-type" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <option value="Field">Field</option>
                                <option value="Process">Process</option>
                                <option value="Material">Material</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                         <div>
                            <label class="block mb-1 font-medium text-gray-700">Category</label>
                            <select id="obs-category" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <option value="Safety">Safety</option>
                                <option value="Installation">Installation</option>
                                <option value="Civil">Civil</option>
                                <option value="Electrical">Electrical</option>
                                <option value="Documentation">Documentation</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Severity</label>
                            <select id="obs-severity" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-1 font-medium text-gray-700">Description</label>
                        <textarea id="obs-description" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Describe the observation..." required></textarea>
                    </div>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Responsible Person</label>
                            <input type="text" id="obs-owner" class="w-full p-2 border border-gray-300 rounded-lg" value="John Doe">
                        </div>
                        <!-- (FIX) This wrapper is hidden by default, shown on edit -->
                        <div id="obs-status-wrapper" class="hidden">
                            <label class="block mb-1 font-medium text-gray-700">Status</label>
                            <select id="obs-status" class="w-full p-2 bg-white border border-gray-300 rounded-lg">
                                <option value="Open">Open</option>
                                <option value="Under Review">Under Review</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-1 font-medium text-gray-700">Photo Upload (Optional)</label>
                        <input type="file" id="obs-photo" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>
                <div class="flex justify-end p-6 bg-gray-50 border-t">
                    <button type="button" class="px-6 py-2 mr-4 font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100" onclick="hideModal('observation-modal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save Observation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NCR Modal (Add/Edit) -->
    <div id="ncr-modal" class="fixed inset-0 z-40 items-center justify-center hidden p-4 modal-backdrop" onclick="hideModal('ncr-modal')">
        <div class="w-full max-w-4xl bg-white rounded-lg shadow-2xl" onclick="event.stopPropagation()">
            <form id="ncr-form" class="flex flex-col">
                <div class="flex items-center justify-between p-6 border-b">
                    <h2 id="ncr-modal-title" class="text-2xl font-bold text-slate-800">Raise New NCR / Add RCA</h2>
                    <button type="button" class="text-gray-400 hover:text-gray-600" onclick="hideModal('ncr-modal')">&times;</button>
                </div>
                <div class="p-6 space-y-6 overflow-y-auto max-h-[70vh]">
                    <!-- NCR Details -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 font-medium text-lg text-slate-700">NCR Details</legend>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                            <div>
                                <label class="block mb-1 font-medium text-gray-700">Related Observation ID</label>
                                <input type="text" id="ncr-obs-id" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., 1729... (optional)">
                            </div>
                             <div>
                                <label class="block mb-1 font-medium text-gray-700">Site</label>
                                <select id="ncr-site" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                    <!-- Site options will be populated by JS -->
                                </select>
                            </div>
                             <div>
                                <label class="block mb-1 font-medium text-gray-700">NCR Title</label>
                                <input type="text" id="ncr-title" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Brief title of non-conformance" required>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block mb-1 font-medium text-gray-700">Detailed Description</label>
                            <textarea id="ncr-description" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Describe the non-conformance..."></textarea>
                        </div>
                    </fieldset>

                    <!-- RCA Section -->
                    <fieldset class="p-4 border rounded-lg">
                        <legend class="px-2 font-medium text-lg text-slate-700">Root Cause Analysis (RCA)</legend>
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-1 font-medium text-gray-700">5-Why Analysis</label>
                                <input type="text" class="w-full p-2 mb-2 border border-gray-300 rounded-lg" placeholder="Why #1?">
                                <input type="text" class="w-full p-2 mb-2 border border-gray-300 rounded-lg" placeholder="Why #2?">
                                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Why #3? ...">
                            </div>
                            <div>
                                <label class="block mb-1 font-medium text-gray-700">Fishbone / Ishikawa (Categories)</label>
                                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., People, Process, Material...">
                            </div>
                             <div>
                                <label class="block mb-1 font-medium text-gray-700">Root Cause Summary</label>
                                <textarea id="rca-summary" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Summarize the final root cause..."></textarea>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="flex justify-end p-6 bg-gray-50 border-t">
                    <button type="button" class="px-6 py-2 mr-4 font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100" onclick="hideModal('ncr-modal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save NCR/RCA</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- CAPA Modal (Add/Edit) -->
    <div id="capa-modal" class="fixed inset-0 z-40 items-center justify-center hidden p-4 modal-backdrop" onclick="hideModal('capa-modal')">
        <div class="w-full max-w-2xl bg-white rounded-lg shadow-2xl" onclick="event.stopPropagation()">
            <form id="capa-form" class="flex flex-col">
                <div class="flex items-center justify-between p-6 border-b">
                    <h2 id="capa-modal-title" class="text-2xl font-bold text-slate-800">Add New Action (CAPA)</h2>
                    <button type="button" class="text-gray-400 hover:text-gray-600" onclick="hideModal('capa-modal')">&times;</button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Action Type</label>
                            <select id="capa-type" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <option value="CA">Corrective Action (CA)</option>
                                <option value="PA">Preventive Action (PA)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Source (NCR ID / Obs. ID)</label>
                            <input type="text" id="capa-source" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., NCR-082" required>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-1 font-medium text-gray-700">Action Description</label>
                        <textarea id="capa-description" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Describe the action to be taken..." required></textarea>
                    </div>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Responsible Person</label>
                            <input type="text" id="capa-owner" class="w-full p-2 border border-gray-300 rounded-lg" value="QA Team">
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Due Date</label>
                            <input type="date" id="capa-due" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Status</label>
                            <select id="capa-status" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <option value="Open">Open</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Closed">Closed</option>
                                <option value="Verified">Verified</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-6 bg-gray-50 border-t">
                    <button type="button" class="px-6 py-2 mr-4 font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100" onclick="hideModal('capa-modal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save Action</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Incident Modal (Add/Edit) -->
    <div id="incident-modal" class="fixed inset-0 z-40 items-center justify-center hidden p-4 modal-backdrop" onclick="hideModal('incident-modal')">
        <div class="w-full max-w-2xl bg-white rounded-lg shadow-2xl" onclick="event.stopPropagation()">
            <form id="incident-form" class="flex flex-col">
                <div class="flex items-center justify-between p-6 bg-red-100 border-b border-red-300">
                    <h2 id="incident-modal-title" class="text-2xl font-bold text-red-800">Report New Incident</h2>
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="hideModal('incident-modal')">&times;</button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Site</label>
                            <select id="inc-site" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <!-- Site options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Date & Time</label>
                            <input type="datetime-local" id="inc-datetime" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                         <div>
                            <label class="block mb-1 font-medium text-gray-700">Incident Type</label>
                            <select id="inc-type" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <option value="Near Miss">Near Miss</option>
                                <option value="First Aid">First Aid</option>
                                <option value="Medical Treatment">Medical Treatment</option>
                                <option value="Lost Time Injury">Lost Time Injury</option>
                                <option value="Property Damage">Property Damage</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium text-gray-700">Severity</label>
                            <select id="inc-severity" class="w-full p-2 bg-white border border-gray-300 rounded-lg" required>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-1 font-medium text-gray-700">Incident Description</label>
                        <textarea id="inc-description" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Describe what happened..." required></textarea>
                    </div>
                    <div>
                        <label class="block mb-1 font-medium text-gray-700">Immediate Action Taken</label>
                        <textarea id="inc-action" rows="2" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Site work stopped, first aid applied..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end p-6 bg-gray-50 border-t">
                    <button type="button" class="px-6 py-2 mr-4 font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100" onclick="hideModal('incident-modal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- =================================================================== -->
    <!-- JAVASCRIPT -->
    <!-- =================================================================== -->
    <script>
        // --- MOCK DATA ---
        const mockData = {
            sites: [
                { id: 1, name: 'Site A (Delta)', location: 'Nevada, USA', capacity: 150, status: 'Active', incharge: 'John Doe', contractor: 'SolarConstruct' },
                { id: 2, name: 'Site B (Gamma)', location: 'Arizona, USA', capacity: 300, status: 'Active', incharge: 'Jane Smith', contractor: 'SunPower' },
                { id: 3, name: 'Site C (Epsilon)', location: 'Texas, USA', capacity: 50, status: 'Planning', incharge: 'Mike Ross', contractor: 'FirstSolar' },
            ],
            observations: [
                { id: 17293, date: '2025-10-24', site: 'Site A (Delta)', type: 'Field', category: 'Installation', severity: 'Medium', status: 'Open', owner: 'John Doe', description: 'Incorrect torque on module clamps batch 12' },
                { id: 17294, date: '2025-10-23', site: 'Site B (Gamma)', type: 'Process', category: 'Documentation', severity: 'Low', status: 'Closed', owner: 'Jane Smith', description: 'MMS drawing revision not updated' },
                { id: 17295, date: '2025-10-22', site: 'Site A (Delta)', type: 'Material', category: 'Electrical', severity: 'High', status: 'Under Review', owner: 'John Doe', description: 'Visible micro-cracks on 3 modules' },
                { id: 17296, date: '2025-10-21', site: 'Site C (Epsilon)', type: 'Safety', category: 'Civil', severity: 'High', status: 'Open', owner: 'Mike Ross', description: 'Improper excavation barricading' },
            ],
            ncrs: [
                { id: 'NCR-081', date: '2025-10-24', site: 'Site A (Delta)', title: 'Incorrect torque values', obsId: 17293, status: 'Open', rca: 'Pending' },
                { id: 'NCR-082', date: '2025-10-22', site: 'Site A (Delta)', title: 'Module micro-cracks found', obsId: 17295, status: 'Open', rca: 'Pending' },
                { id: 'NCR-083', date: '2025-10-21', site: 'Site C (Epsilon)', title: 'Excavation safety violation', obsId: 17296, status: 'Action Planned', rca: 'Completed' },
            ],
            capa: [
                { id: 'CA-040', type: 'CA', source: 'NCR-083', action: 'Re-train all civil staff on excavation safety', owner: 'Mike Ross', due: '2025-10-28', status: 'In Progress' },
                { id: 'PA-012', type: 'PA', source: 'NCR-083', action: 'Implement mandatory daily site safety audits', owner: 'QA Team', due: '2025-11-01', status: 'Open' },
            ],
            incidents: [
                { id: 'INC-021', date: '2025-10-20', site: 'Site B (Gamma)', type: 'Near Miss', severity: 'Medium', description: 'Tool dropped from height, landed near worker', action: 'Work stopped, toolbox talk conducted', status: 'Reported' },
                { id: 'INC-022', date: '2025-09-15', site: 'Site A (Delta)', type: 'First Aid', severity: 'Low', description: 'Minor cut from handling module frame', action: 'First aid applied, PPE check reinforced', status: 'Closed' },
            ]
        };

        // --- GLOBALLY ACCESSIBLE FUNCTIONS (for inline onclick) ---
        
        // This will track what item is being edited
        window.currentlyEditing = null;

        /**
         * Shows a modal
         * @param {string} modalId The ID of the modal to show
         * @param {string | null} title Optional title to set
         */
        window.showModal = (modalId, title = null) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Set title if provided
                if (title) {
                    const titleEl = modal.querySelector('h2'); // Assumes h2 is the title
                    if (titleEl) {
                        titleEl.textContent = title;
                    }
                }
                
                // (FIX) Handle state for 'Add New Observation'
                if (modalId === 'observation-modal' && title && title.toLowerCase().includes('log new')) {
                    document.getElementById('obs-status-wrapper').classList.add('hidden');
                    document.getElementById('obs-status').removeAttribute('required');
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        };

        /**
         * Hides a modal
         * @param {string} modalId The ID of the modal to hide
         */
        window.hideModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // Reset editing state and the form
                window.currentlyEditing = null;
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
                
                // (FIX) Specifically hide the obs status wrapper on any close
                if (modalId === 'observation-modal') {
                    document.getElementById('obs-status-wrapper').classList.add('hidden');
                    // (FIX) Also remove 'required' to prevent validation block on add-new
                    document.getElementById('obs-status').removeAttribute('required');
                }
            }
        };
        
        /**
         * Exports data from a table to an Excel file
         * @param {string} dataKey - The key from mockData (e.g., 'sites', 'observations')
         */
        window.exportData = (dataKey) => {
            if (!window.XLSX) {
                alert('Excel export library not found.');
                return;
            }
            
            let data = mockData[dataKey];
            if (!data) {
                alert('No data found for export.');
                return;
            }
            
            const worksheet = window.XLSX.utils.json_to_sheet(data);
            const workbook = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(workbook, worksheet, dataKey);
            
            // Generate file and trigger download
            window.XLSX.writeFile(workbook, `SPQMS_${dataKey}_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
        };
        
        /**
         * Gets current date as YYYY-MM-DD
         */
        const getTodayDate = () => {
            return new Date().toISOString().split('T')[0];
        };
        
        /**
         * Shows item details in the correct edit modal
         * @param {string} type - The key from mockData (e.g., 'Site', 'Observation')
         * @param {string|number} id - The ID of the item to find
         */
        window.editItem = (type, id) => {
            let item;
            let dataKey = type.toLowerCase() + 's';
            if (type === 'CAPA') dataKey = 'capa';
            if (type === 'NCR') dataKey = 'ncrs'; // Fix pluralization
            if (type === 'Incident') dataKey = 'incidents'; // Fix pluralization

            item = mockData[dataKey]?.find(i => i.id == id);
            
            if (!item) {
                console.error(`Could not find item of type '${type}' with id '${id}'.`);
                return;
            }
            
            window.currentlyEditing = { type, id };

            switch(type) {
                case 'Site':
                    document.getElementById('site-name').value = item.name;
                    document.getElementById('site-location').value = item.location;
                    document.getElementById('site-capacity').value = item.capacity;
                    document.getElementById('site-status').value = item.status;
                    document.getElementById('site-contractor').value = item.contractor || '';
                    document.getElementById('site-incharge').value = item.incharge;
                    showModal('site-modal', 'Edit Site');
                    break;
                case 'Observation':
                    document.getElementById('obs-site').value = item.site;
                    document.getElementById('obs-type').value = item.type;
                    document.getElementById('obs-category').value = item.category;
                    document.getElementById('obs-severity').value = item.severity;
                    document.getElementById('obs-description').value = item.description || '';
                    document.getElementById('obs-owner').value = item.owner;
                    
                    // (FIX) Show, set, and require the status field
                    document.getElementById('obs-status-wrapper').classList.remove('hidden');
                    document.getElementById('obs-status').value = item.status;
                    document.getElementById('obs-status').setAttribute('required', 'required');
                    
                    showModal('observation-modal', 'Edit Observation');
                    break;
                case 'NCR':
                    document.getElementById('ncr-obs-id').value = item.obsId || '';
                    document.getElementById('ncr-site').value = item.site;
                    document.getElementById('ncr-title').value = item.title;
                    document.getElementById('ncr-description').value = item.description || '';
                    // Note: RCA fields are complex, skipping pre-fill for this demo
                    showModal('ncr-modal', 'Edit NCR (RCA fields not pre-filled)');
                    break;
                case 'CAPA':
                    document.getElementById('capa-type').value = item.type;
                    document.getElementById('capa-source').value = item.source;
                    document.getElementById('capa-description').value = item.action;
                    document.getElementById('capa-owner').value = item.owner;
                    document.getElementById('capa-due').value = item.due;
                    document.getElementById('capa-status').value = item.status;
                    showModal('capa-modal', 'Edit Action (CAPA)');
                    break;
                case 'Incident':
                    document.getElementById('inc-site').value = item.site;
                    // Handle datetime-local
                    const incDate = item.date.includes('T') ? item.date : `${item.date}T00:00`;
                    document.getElementById('inc-datetime').value = incDate;
                    document.getElementById('inc-type').value = item.type;
                    document.getElementById('inc-severity').value = item.severity;
                    document.getElementById('inc-description').value = item.description || '';
                    document.getElementById('inc-action').value = item.action || '';
                    showModal('incident-modal', 'Edit Incident Report');
                    break;
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            const pageTitle = document.getElementById('page-title');
            const navLinks = document.querySelectorAll('.nav-link');
            
            // --- Chart Instances (to be destroyed/recreated if data changes) ---
            let ncrChartInstance = null;
            let siteChartInstance = null;

            // --- PAGE NAVIGATION ---
            window.navigate = (pageId) => {
                // Hide all pages
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.add('hidden');
                });
                
                // Show target page
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }
                
                // Update header title
                const linkText = document.querySelector(`.nav-link[href="#${pageId}"]`).querySelector('span').textContent;
                pageTitle.textContent = linkText;

                // Update active nav link
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === `#${pageId}`) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                
                // Re-render charts if navigating to dashboard
                if (pageId === 'dashboard') {
                    renderDashboardCharts();
                    renderRecentActivity();
                }
            };
            
            // --- DATA RENDERING ---

            const renderSitesTable = () => {
                const tbody = document.getElementById('sites-tbody');
                tbody.innerHTML = '';
                mockData.sites.forEach(site => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">SITE-${String(site.id).padStart(3, '0')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${site.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${site.location}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${site.capacity} MW</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${site.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${site.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${site.incharge}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                                <a href="#" class="text-blue-600 hover:text-blue-900" onclick="event.preventDefault(); editItem('Site', ${site.id})">Edit</a>
                            </td>
                        </tr>
                    `;
                });
            };

            const renderObservationsTable = () => {
                const tbody = document.getElementById('observations-tbody');
                tbody.innerHTML = '';
                mockData.observations.forEach(obs => {
                    let severityClass = '';
                    if (obs.severity === 'High') severityClass = 'text-red-600 font-bold';
                    if (obs.severity === 'Medium') severityClass = 'text-yellow-600 font-bold';
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${obs.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obs.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obs.site}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obs.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obs.category}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${severityClass}">${obs.severity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obs.status}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                                <a href="#" class="text-blue-600 hover:text-blue-900" onclick="event.preventDefault(); editItem('Observation', ${obs.id})">Edit</a>
                            </td>
                        </tr>
                    `;
                });
            };
            
            const renderNCRsTable = () => {
                const tbody = document.getElementById('ncrs-tbody');
                tbody.innerHTML = '';
                mockData.ncrs.forEach(ncr => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ncr.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ncr.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ncr.site}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ncr.title}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${ncr.status === 'Open' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                    ${ncr.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ncr.rca}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                                <a href="#" class="text-blue-600 hover:text-blue-900" onclick="event.preventDefault(); editItem('NCR', '${ncr.id}')">View/Edit</a>
                            </td>
                        </tr>
                    `;
                });
            };
            
            const renderCAPATable = () => {
                const tbody = document.getElementById('capa-tbody');
                tbody.innerHTML = '';
                mockData.capa.forEach(item => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${item.type === 'CA' ? 'text-orange-600' : 'text-blue-600'}">${item.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.source}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs">${item.action}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.due}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.status}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                                <a href="#" class="text-blue-600 hover:text-blue-900" onclick="event.preventDefault(); editItem('CAPA', '${item.id}')">Edit</a>
                            </td>
                        </tr>
                    `;
                });
            };
            
            const renderIncidentsTable = () => {
                const tbody = document.getElementById('incidents-tbody');
                tbody.innerHTML = '';
                mockData.incidents.forEach(inc => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-700">${inc.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${inc.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${inc.site}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${inc.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${inc.severity === 'High' || inc.severity === 'Critical' ? 'text-red-600' : 'text-yellow-600'}">${inc.severity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${inc.status}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                                <a href="#" class="text-blue-600 hover:text-blue-900" onclick="event.preventDefault(); editItem('Incident', '${inc.id}')">View/Edit</a>
                            </td>
                        </tr>
                    `;
                });
            };
            
            const renderRecentActivity = () => {
                const tbody = document.getElementById('recent-activity-tbody');
                tbody.innerHTML = '';
                
                // Combine and sort all recent activities
                const allActivity = [
                    ...mockData.observations.map(o => ({ ...o, type: 'Observation', details: o.description })),
                    ...mockData.ncrs.map(n => ({ ...n, type: 'NCR', details: n.title })),
                    ...mockData.incidents.map(i => ({ ...i, type: 'Incident', details: i.description }))
                ];
                
                allActivity.sort((a, b) => new Date(b.date) - new Date(a, b));
                
                allActivity.slice(0, 5).forEach(item => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.site}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${item.type === 'Incident' ? 'text-red-600' : (item.type === 'NCR' ? 'text-yellow-700' : 'text-blue-600')}">${item.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-md">${item.details}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.status}</td>
                        </tr>
                    `;
                });
            };

            const renderDashboardCharts = () => {
                // --- Chart 1: NCR Trend ---
                if (ncrChartInstance) ncrChartInstance.destroy();
                const ncrCtx = document.getElementById('ncrTrendChart').getContext('2d');
                ncrChartInstance = new Chart(ncrCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jul', 'Aug', 'Sep', 'Oct'],
                        datasets: [{
                            label: 'Open NCRs',
                            data: [3, 5, 8, 3], // Mock data
                            borderColor: '#ef4444', // red-500
                            backgroundColor: '#fee2e2', // red-100
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // --- Chart 2: Site Performance (Bar) ---
                if (siteChartInstance) siteChartInstance.destroy();
                const siteCtx = document.getElementById('sitePerformanceChart').getContext('2d');
                siteChartInstance = new Chart(siteCtx, {
                    type: 'bar',
                    data: {
                        labels: mockData.sites.map(s => s.name),
                        datasets: [
                            {
                                label: 'Open NCRs',
                                data: [
                                    mockData.ncrs.filter(n => n.site === 'Site A (Delta)' && n.status === 'Open').length,
                                    mockData.ncrs.filter(n => n.site === 'Site B (Gamma)' && n.status === 'Open').length,
                                    mockData.ncrs.filter(n => n.site === 'Site C (Epsilon)' && n.status === 'Open').length,
                                ],
                                backgroundColor: '#ef4444', // red-500
                            },
                            {
                                label: 'Total Observations',
                                data: [
                                    mockData.observations.filter(o => o.site === 'Site A (Delta)').length,
                                    mockData.observations.filter(o => o.site === 'Site B (Gamma)').length,
                                    mockData.observations.filter(o => o.site === 'Site C (Epsilon)').length,
                                ],
                                backgroundColor: '#3b82f6', // blue-500
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } }
                    }
                });
            };

            // --- AI Assistant (Gemini API Call) ---
            const callGeminiApi = async (prompt) => {
                const aiLoading = document.getElementById('ai-loading');
                const aiResult = document.getElementById('ai-result');
                const aiBtn = document.getElementById('ai-suggest-btn');
                
                aiLoading.classList.remove('hidden');
                aiResult.classList.add('hidden');
                aiBtn.disabled = true;

                const apiKey = ""; // Leave blank, will be autopopulated
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const systemPrompt = "You are an expert solar quality engineer. A user is asking for help with a quality issue. Provide a concise, actionable list of: 1. Potential Root Causes, and 2. Recommended Corrective/Preventive Actions. Base your answer on industry best practices (e.g., NREL, IEEE standards).";
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    tools: [{ "google_search": {} }], // Use Google Search for grounded, real-time data
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        // Simple markdown-to-HTML
                        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        html = html.replace(/1\.|2\./g, '<br><strong class="mt-2 block">$&</strong>');
                        html = html.replace(/\*/g, '<br>&bull; ');
                        
                        aiResult.innerHTML = html;
                        aiResult.classList.remove('hidden');
                    } else {
                        throw new Error("No valid response from AI.");
                    }
                } catch (error) {
                    console.error("AI Error:", error);
                    aiResult.innerHTML = `<strong>Error:</strong> Could not get suggestion. ${error.message}`;
                    aiResult.classList.remove('hidden');
                } finally {
                    aiLoading.classList.add('hidden');
                    aiBtn.disabled = false;
                }
            };
            
            document.getElementById('ai-suggest-btn').addEventListener('click', () => {
                const prompt = document.getElementById('ai-prompt-input').value;
                if (prompt.trim()) {
                    callGeminiApi(`Suggest RCA and CAPA for: ${prompt}`);
                } else {
                    document.getElementById('ai-result').textContent = 'Please enter an issue description first.';
                    document.getElementById('ai-result').classList.remove('hidden');
                }
            });

            // --- FORM SUBMISSION HANDLERS ---
            
            const updateKpiCards = () => {
                // 1. Total Observations
                const totalObs = mockData.observations.length;
                document.getElementById('kpi-total-obs').textContent = totalObs.toLocaleString();

                // 2. Open NCRs
                const openNcrs = mockData.ncrs.filter(ncr => ncr.status.toLowerCase() === 'open').length;
                document.getElementById('kpi-open-ncrs').textContent = openNcrs.toLocaleString();

                // 3. Pending RCAs
                const pendingRcas = mockData.ncrs.filter(ncr => ncr.rca.toLowerCase() === 'pending').length;
                document.getElementById('kpi-pending-rcas').textContent = pendingRcas.toLocaleString();

                // 4. Incidents (L30D)
                const today = new Date('2025-10-25'); // Fix "today" relative to mock data
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);

                const recentIncidents = mockData.incidents.filter(inc => {
                    const incDate = new Date(inc.date.split('T')[0]);
                    return incDate >= thirtyDaysAgo && incDate <= today;
                }).length;
                document.getElementById('kpi-incidents').textContent = recentIncidents.toLocaleString();

                // 5. Quality Index (Closed NCRs / Total NCRs)
                const totalNcrs = mockData.ncrs.length;
                const closedNcrs = mockData.ncrs.filter(ncr => 
                    ncr.status.toLowerCase() !== 'open'
                ).length;
                
                const qualityIndex = (totalNcrs > 0) ? (closedNcrs / totalNcrs) * 100 : 100;
                document.getElementById('kpi-quality-index').textContent = qualityIndex.toFixed(1) + '%';
            };
            
            const updateSiteDropdowns = () => {
                const dropdowns = document.querySelectorAll('#site-filter, #obs-site, #ncr-site, #inc-site');
                
                dropdowns.forEach(dropdown => {
                    // Clear existing options (except 'All Sites' if it exists)
                    const firstOption = dropdown.querySelector('option');
                    dropdown.innerHTML = '';
                    if (firstOption && firstOption.value === 'all') {
                        dropdown.appendChild(firstOption);
                    }
                    
                    // Add new options
                    mockData.sites.forEach(site => {
                        const option = document.createElement('option');
                        option.value = site.name;
                        option.textContent = site.name;
                        dropdown.appendChild(option);
                    });
                });
            };
            
            document.getElementById('site-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (window.currentlyEditing && window.currentlyEditing.type === 'Site') {
                    // --- EDIT LOGIC ---
                    const item = mockData.sites.find(s => s.id === window.currentlyEditing.id);
                    if (item) {
                        item.name = document.getElementById('site-name').value;
                        item.location = document.getElementById('site-location').value;
                        item.capacity = document.getElementById('site-capacity').value;
                        item.status = document.getElementById('site-status').value;
                        item.contractor = document.getElementById('site-contractor').value;
                        item.incharge = document.getElementById('site-incharge').value;
                    }
                } else {
                    // --- ADD NEW LOGIC ---
                    const newSite = {
                        id: Date.now(),
                        name: document.getElementById('site-name').value,
                        location: document.getElementById('site-location').value,
                        capacity: document.getElementById('site-capacity').value,
                        status: document.getElementById('site-status').value,
                        incharge: document.getElementById('site-incharge').value,
                        contractor: document.getElementById('site-contractor').value
                    };
                    mockData.sites.push(newSite);
                }
                
                renderSitesTable();
                updateSiteDropdowns();
                hideModal('site-modal');
                e.target.reset();
            });
            
            document.getElementById('observation-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (window.currentlyEditing && window.currentlyEditing.type === 'Observation') {
                    // --- EDIT LOGIC ---
                    const item = mockData.observations.find(o => o.id === window.currentlyEditing.id);
                    if (item) {
                        item.site = document.getElementById('obs-site').value;
                        item.type = document.getElementById('obs-type').value;
                        item.category = document.getElementById('obs-category').value;
                        item.severity = document.getElementById('obs-severity').value;
                        item.description = document.getElementById('obs-description').value;
                        item.owner = document.getElementById('obs-owner').value;
                        item.status = document.getElementById('obs-status').value; // Save status
                    }
                } else {
                    // --- ADD NEW LOGIC ---
                    const newObservation = {
                        id: Date.now(),
                        date: getTodayDate(),
                        site: document.getElementById('obs-site').value,
                        type: document.getElementById('obs-type').value,
                        category: document.getElementById('obs-category').value,
                        severity: document.getElementById('obs-severity').value,
                        description: document.getElementById('obs-description').value,
                        status: 'Open', // New observations are always Open
                        owner: document.getElementById('obs-owner').value
                    };
                    mockData.observations.push(newObservation);
                }
                
                renderObservationsTable();
                updateKpiCards();
                hideModal('observation-modal');
                e.target.reset();
            });
            
            document.getElementById('ncr-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (window.currentlyEditing && window.currentlyEditing.type === 'NCR') {
                    // --- EDIT LOGIC ---
                    const item = mockData.ncrs.find(n => n.id === window.currentlyEditing.id);
                    if (item) {
                        item.obsId = document.getElementById('ncr-obs-id').value;
                        item.site = document.getElementById('ncr-site').value;
                        item.title = document.getElementById('ncr-title').value;
                        item.description = document.getElementById('ncr-description').value;
                        // Note: Logic for updating status/RCA would be more complex
                    }
                } else {
                    // --- ADD NEW LOGIC ---
                    const newNcr = {
                        id: `NCR-${Math.floor(100 + Math.random() * 900)}`,
                        date: getTodayDate(),
                        site: document.getElementById('ncr-site').value,
                        title: document.getElementById('ncr-title').value,
                        description: document.getElementById('ncr-description').value,
                        obsId: document.getElementById('ncr-obs-id').value,
                        status: 'Open',
                        rca: 'Pending'
                    };
                    mockData.ncrs.push(newNcr);
                }

                renderNCRsTable();
                updateKpiCards();
                hideModal('ncr-modal');
                e.target.reset();
            });
            
            document.getElementById('capa-form').addEventListener('submit', (e) => {
                e.preventDefault();

                if (window.currentlyEditing && window.currentlyEditing.type === 'CAPA') {
                    // --- EDIT LOGIC ---
                    const item = mockData.capa.find(c => c.id === window.currentlyEditing.id);
                    if (item) {
                        item.type = document.getElementById('capa-type').value;
                        item.source = document.getElementById('capa-source').value;
                        item.action = document.getElementById('capa-description').value;
                        item.owner = document.getElementById('capa-owner').value;
                        item.due = document.getElementById('capa-due').value;
                        item.status = document.getElementById('capa-status').value;
                    }
                } else {
                    // --- ADD NEW LOGIC ---
                    const newCapa = {
                        id: `${document.getElementById('capa-type').value}-${Math.floor(100 + Math.random() * 900)}`,
                        type: document.getElementById('capa-type').value,
                        source: document.getElementById('capa-source').value,
                        action: document.getElementById('capa-description').value,
                        owner: document.getElementById('capa-owner').value,
                        due: document.getElementById('capa-due').value,
                        status: document.getElementById('capa-status').value
                    };
                    mockData.capa.push(newCapa);
                }
                
                renderCAPATable();
                hideModal('capa-modal');
                e.target.reset();
            });
            
            document.getElementById('incident-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const incidentDate = document.getElementById('inc-datetime').value || new Date().toISOString();

                if (window.currentlyEditing && window.currentlyEditing.type === 'Incident') {
                    // --- EDIT LOGIC ---
                    const item = mockData.incidents.find(i => i.id === window.currentlyEditing.id);
                    if (item) {
                        item.date = incidentDate.split('T')[0];
                        item.site = document.getElementById('inc-site').value;
                        item.type = document.getElementById('inc-type').value;
                        item.severity = document.getElementById('inc-severity').value;
                        item.description = document.getElementById('inc-description').value;
                        item.action = document.getElementById('inc-action').value;
                        // Note: Status logic would be here
                    }
                } else {
                    // --- ADD NEW LOGIC ---
                    const newIncident = {
                        id: `INC-${Math.floor(100 + Math.random() * 900)}`,
                        date: incidentDate.split('T')[0],
                        site: document.getElementById('inc-site').value,
                        type: document.getElementById('inc-type').value,
                        severity: document.getElementById('inc-severity').value,
                        description: document.getElementById('inc-description').value,
                        action: document.getElementById('inc-action').value,
                        status: 'Reported'
                    };
                    mockData.incidents.push(newIncident);
                }

                renderIncidentsTable();
                updateKpiCards();
                hideModal('incident-modal');
                e.target.reset();
            });

            // --- INITIALIZATION ---
            const init = () => {
                updateSiteDropdowns();
                renderSitesTable();
                renderObservationsTable();
                renderNCRsTable();
                renderCAPATable();
                renderIncidentsTable();
                updateKpiCards();
                
                // Start on the dashboard
                navigate('dashboard');
            };

            init();
        });
    </script>
</body>
</html>

