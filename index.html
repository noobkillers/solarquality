--- Code.gs ---
```javascript
// Code.gs - Apps Script for SPQMS Dashboard
// Paste this into Apps Script (Code.gs)

const SHEET_NAMES = {
  sites: 'Sites',
  observations: 'Observations',
  ncrs: 'NCRs',
  capa: 'CAPA',
  incidents: 'Incidents'
};

// Serve HTML (Index) file
function doGet(e){
  return HtmlService.createHtmlOutputFromFile('Index')
    .setTitle('SPQMS Dashboard')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// ----------------- Helpers -----------------
function readSheetAsObjects(sheetName){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(sheetName);
  if(!sh) return [];
  const data = sh.getDataRange().getValues();
  if(data.length < 2) return [];
  const headers = data[0];
  const rows = [];
  for(let r=1;r<data.length;r++){
    const row = data[r];
    const obj = {};
    for(let c=0;c<headers.length;c++){
      obj[headers[c]] = row[c];
    }
    rows.push(obj);
  }
  return rows;
}

function findRowById(sheetName, idColumnName, idValue){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(sheetName);
  if(!sh) return -1;
  const values = sh.getDataRange().getValues();
  if(values.length < 2) return -1;
  const headers = values[0];
  const idColIndex = headers.indexOf(idColumnName);
  if(idColIndex < 0) return -1;
  for(let r=1;r<values.length;r++){
    if(String(values[r][idColIndex]) === String(idValue)){
      return r+1;
    }
  }
  return -1;
}

function updateRowById(sheetName, idColumnName, obj){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(sheetName);
  if(!sh) throw new Error('Sheet not found: ' + sheetName);
  const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  const idVal = obj[idColumnName];
  const rowNum = findRowById(sheetName, idColumnName, idVal);
  if(rowNum === -1) throw new Error('Row not found for id: ' + idVal);
  const rowValues = headers.map(h => obj.hasOwnProperty(h) ? obj[h] : sh.getRange(rowNum, headers.indexOf(h)+1).getValue());
  sh.getRange(rowNum, 1, 1, headers.length).setValues([rowValues]);
  return obj;
}

function appendRow(sheetName, obj, idColumnName){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(sheetName);
  if(!sh) throw new Error('Sheet not found: ' + sheetName);
  const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  if(!obj[idColumnName]){
    obj[idColumnName] = generateId(sheetName);
  }
  const rowValues = headers.map(h => obj.hasOwnProperty(h) ? obj[h] : '');
  sh.appendRow(rowValues);
  return obj;
}

function generateId(prefix){
  const ts = new Date().getTime();
  return prefix.slice(0,3).toUpperCase() + '-' + (Math.floor(100 + Math.random()*900)) + '-' + (''+ts).slice(-6);
}

// ----------------- Public API -----------------
function getAllData(){
  return {
    sites: readSheetAsObjects(SHEET_NAMES.sites),
    observations: readSheetAsObjects(SHEET_NAMES.observations),
    ncrs: readSheetAsObjects(SHEET_NAMES.ncrs),
    capa: readSheetAsObjects(SHEET_NAMES.capa),
    incidents: readSheetAsObjects(SHEET_NAMES.incidents)
  };
}

function saveSite(siteObj){
  const idCol = 'id';
  if(siteObj[idCol] && findRowById(SHEET_NAMES.sites, idCol, siteObj[idCol]) !== -1){
    return updateRowById(SHEET_NAMES.sites, idCol, siteObj);
  } else {
    return appendRow(SHEET_NAMES.sites, siteObj, idCol);
  }
}

function saveObservation(obsObj){
  const idCol = 'id';
  if(obsObj[idCol] && findRowById(SHEET_NAMES.observations, idCol, obsObj[idCol]) !== -1){
    return updateRowById(SHEET_NAMES.observations, idCol, obsObj);
  } else {
    return appendRow(SHEET_NAMES.observations, obsObj, idCol);
  }
}

function saveNCR(ncrObj){
  const idCol = 'id';
  if(ncrObj[idCol] && findRowById(SHEET_NAMES.ncrs, idCol, ncrObj[idColumnName]) !== -1){
    return updateRowById(SHEET_NAMES.ncrs, idCol, ncrObj);
  } else {
    return appendRow(SHEET_NAMES.ncrs, ncrObj, idCol);
  }
}

function saveCAPA(capaObj){
  const idCol = 'id';
  if(capaObj[idCol] && findRowById(SHEET_NAMES.capa, idCol, capaObj[idCol]) !== -1){
    return updateRowById(SHEET_NAMES.capa, idCol, capaObj);
  } else {
    return appendRow(SHEET_NAMES.capa, capaObj, idCol);
  }
}

function saveIncident(incObj){
  const idCol = 'id';
  if(incObj[idCol] && findRowById(SHEET_NAMES.incidents, idCol, incObj[idCol]) !== -1){
    return updateRowById(SHEET_NAMES.incidents, idCol, incObj);
  } else {
    return appendRow(SHEET_NAMES.incidents, incObj, idCol);
  }
}

/**
 * Import JSON array into a sheet
 */
function importData(dataKey, rowsArray){
  if (!rowsArray || !rowsArray.length) return getAllData();
  const sheetMap = {
    sites: SHEET_NAMES.sites,
    observations: SHEET_NAMES.observations,
    ncrs: SHEET_NAMES.ncrs,
    capa: SHEET_NAMES.capa,
    incidents: SHEET_NAMES.incidents
  };
  const sheetName = sheetMap[dataKey];
  if (!sheetName) throw new Error('Invalid dataKey: ' + dataKey);
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(sheetName);
  if (!sh) throw new Error('Sheet not found: ' + sheetName);
  const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  const idColIndex = headers.indexOf('id');
  let existingIdMap = {};
  if (idColIndex >= 0) {
    const idValues = sh.getRange(2, idColIndex + 1, Math.max(0, sh.getLastRow()-1), 1).getValues();
    for (let i = 0; i < idValues.length; i++) {
      const val = idValues[i][0];
      if (val !== '') {
        existingIdMap[String(val)] = i + 2;
      }
    }
  }
  rowsArray.forEach(function(obj){
    for (var k in obj) {
      if (Object.prototype.toString.call(obj[k]) === '[object Date]') {
        obj[k] = Utilities.formatDate(obj[k], Session.getScriptTimeZone(), 'yyyy-MM-dd');
      }
    }
    const objId = obj['id'];
    if (objId && existingIdMap[String(objId)]) {
      const rowNum = existingIdMap[String(objId)];
      const rowValues = headers.map(function(h) {
        return obj.hasOwnProperty(h) ? obj[h] : sh.getRange(rowNum, headers.indexOf(h) + 1).getValue();
      });
      sh.getRange(rowNum, 1, 1, headers.length).setValues([rowValues]);
    } else {
      if (!obj['id']) {
        obj['id'] = generateId(sheetName);
      }
      const rowValues = headers.map(function(h) {
        return obj.hasOwnProperty(h) ? obj[h] : '';
      });
      sh.appendRow(rowValues);
      existingIdMap[String(obj['id'])] = sh.getLastRow();
    }
  });
  return getAllData();
}

// Optional: log edits
function logEdit(oldObj, newObj, userEmail){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let audit = ss.getSheetByName('Edit Audit');
  if(!audit) audit = ss.insertSheet('Edit Audit');
  const headers = ['timestamp','row','user','field','old','new'];
  if(audit.getLastRow() === 0) audit.appendRow(headers);
  const now = new Date();
  const row = oldObj.__rowNum || newObj.__rowNum || '';
  for(let k in newObj){
    if(k === '__rowNum') continue;
    const a = oldObj[k] || '';
    const b = newObj[k] || '';
    if(String(a) !== String(b)){
      audit.appendRow([now, row, userEmail || Session.getActiveUser().getEmail(), k, a, b]);
    }
  }
}
```

--- Index.html ---
```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPQMS Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    ::-webkit-scrollbar { width:8px; height:8px }
    ::-webkit-scrollbar-track { background:#f1f5f9 }
    ::-webkit-scrollbar-thumb { background:#94a3b8; border-radius:10px }
    ::-webkit-scrollbar-thumb:hover{ background:#64748b }
    .modal-backdrop{ background-color: rgba(0,0,0,0.5); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); }
    .nav-link.active{ background-color:#e0f2fe; color:#0284c7; font-weight:600 }
    .nav-link.active .nav-icon{ color:#0284c7 }
    .page-content{ animation: fadeIn 0.3s ease-in-out }
    @keyframes fadeIn{ from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .chart-container{ position:relative; width:100%; height:350px }
    /* Mobile tweaks */
    @media (max-width:640px){
      table.min-w-full thead{ display:none }
      table.min-w-full tbody td{ display:block; width:100% }
      table.min-w-full tbody tr{ margin-bottom:12px; display:block; border-bottom:1px solid #e6eef8; padding-bottom:8px }
      .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)) }
      button, .btn{ padding:12px 14px; font-size:14px }
      .modal-backdrop > div{ width:100% !important; height:100% !important; border-radius:0 }
      .modal-backdrop{ align-items:flex-start; padding-top:2rem }
    }
    @media (min-width:641px){ .kpi-grid{ grid-template-columns: repeat(5, minmax(0,1fr)) } }
    .file-import-label button{ -webkit-tap-highlight-color: transparent; touch-action: manipulation }
  </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">
  <div class="flex h-screen overflow-hidden">
    <aside class="hidden md:flex-shrink-0 md:flex md:w-64 bg-white shadow-lg overflow-y-auto">
      <!-- sidebar content same as your original (omitted for brevity in preview) -->
      <div class="flex items-center justify-center p-6 border-b">
        <svg class="w-10 h-10 text-yellow-500" ...></svg>
        <span class="ml-3 text-2xl font-bold text-slate-700">SPQMS</span>
      </div>
      <nav class="mt-6"> <!-- links --> </nav>
    </aside>

    <main class="flex-1 w-full h-screen overflow-y-auto">
      <header class="flex items-center justify-between p-6 bg-white border-b">
        <div class="flex items-center">
          <button id="hamburger-btn" class="md:hidden mr-3 p-2 rounded-md text-slate-700" aria-label="Toggle navigation" onclick="toggleSidebar()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
          </button>
          <h1 id="page-title" class="text-3xl font-bold text-slate-800">Dashboard</h1>
          <div class="ml-6">
            <label for="site-filter" class="text-sm font-medium text-gray-700">Filter by Site:</label>
            <select id="site-filter" class="p-2 ml-2 text-sm bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-bl
